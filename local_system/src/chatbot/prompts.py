from langchain.prompts import ChatPromptTemplate

def get_solve_event_prompt(image: str, event_explain: str, rag: str) -> ChatPromptTemplate:
    return ChatPromptTemplate.from_messages([
        (
            "system",
            "당신은 산업시설 및 공정 안전 분야의 시니어 기술 컨설턴트입니다. "
            "당신의 주요 업무는 현장에서 발생한 사고 또는 이상 징후에 대해 다각도로 원인을 분석하고, "
            "기술적 · 인프라적 · 조직 운영 측면에서 실질적인 해결 방안을 제시하는 것입니다.\n\n"
            "다음의 정보(사건 설명, 참고 이미지, 관련 문헌 요약)를 바탕으로 다음 요구사항을 충족하는 분석 및 해결 방안을 작성하세요:\n\n"
            "1. **문제 개요 요약**: 사고 또는 이슈가 발생한 배경과 상황을 간결하게 요약합니다.\n"
            "2. **원인 분석**: 직접 원인(root cause), 간접 요인(contributing factors), 시스템적 결함(systemic flaws)을 분리하여 구조적으로 기술합니다.\n"
            "3. **과거 사례와 비교 분석**: 제공된 참고자료에서 유사 사례를 인용하고, 본 사건과의 유사점 및 차이점을 비교합니다.\n"
            "4. **기술적 해결방안**: 현장 적용 가능한 기술적 조치(장비 개선, 회로 재설계, 계측 시스템 활용 등)를 단계별로 제안합니다.\n"
            "5. **운영 절차 개선**: 작업자 교육, SOP 개정, 실시간 모니터링 강화 등 비기술적 대응 방안도 포함합니다.\n"
            "6. **예방 및 재발 방지 대책**: 해당 사건의 재발을 막기 위한 중장기 전략(예: 예측 유지보수 체계, 리스크 평가 프로토콜, KPI 연계 관리)을 기술합니다.\n\n"
            "※ 응답은 전문가 보고서 양식에 맞춰 **번호를 포함한 구조적 서술**, **간결하고 전문적인 문장**, **필요시 용어 정의**를 포함해 주세요."
        ),
        (
            "user",
            [
                {
                    "type": "image_url",
                    "image_url": {"url": f"data:image/jpeg;base64,{image}"}
                },
                {
                    "type": "text",
                    "text": (
                        f"[문제 설명]\n{event_explain}\n\n"
                        f"[참고자료 요약]\n{rag}"
                    )
                }
            ]
        )
    ])


# solve_event 응답:

# I'm unable to provide a detailed analysis without the reference material. However, based on the image and description, here's a general analysis and solution approach:

# ---


# ---

# 1. **문제 개요 요약**:
#    - 서버실 내에서 과도한 전력 사용으로 인해 일부 장비가 꺼졌으며, 전선에서 연기가 발생하는 등 전기적 문제가 발생했습니다.

# 2. **원인 분석**:
#    - **직접 원인**: 전력 과부하로 인한 장비의 전원 차단.
#    - **간접 요인**: 부적절한 전력 분배, 과도한 장비 사용, 냉각 시스템의 비효율.
#    - **시스템적 결함**: 전력 관리 시스템의 부재, 경고 시스템 미비.

# 3. **과거 사례와 비교 분석**:
#    - 유사 사례에서는 전력 관리 시스템의 부재로 인한 과부하가 주요 원인이었으며, 적절한 전력 모니터링 시스템 도입으로 해결되었습니다.

# 4. **기술적 해결방안**:
#    - **전력 모니터링 시스템 설치**: 실시간 전력 사용량을 모니터링하여 과부하를 방지.
#    - **전력 분배 개선**: 전력 분배기를 통해 각 장비에 적절한 전력을 공급.
#    - **냉각 시스템 업그레이드**: 효율적인 냉각 시스템으로 장비 과열 방지.

# 5. **운영 절차 개선**:
#    - **작업자 교육**: 전력 관리 및 응급 상황 대처 교육 강화.
#    - **SOP 개정**: 전력 사용량 모니터링 및 보고 절차 추가.
#    - **실시간 모니터링 강화**: 전력 사용량 및 장비 상태를 실시간으로 모니터링.

# 6. **예방 및 재발 방지 대책**:
#    - **예측 유지보수 체계 도입**: 장비의 상태를 사전에 점검하여 문제 발생을 예방.
#    - **리스크 평가 프로토콜**: 정기적인 리스크 평가를 통해 잠재적 문제를 식별.
#    - **KPI 연계 관리**: 전력 사용량 및 장비 가동률을 KPI로 설정하여 관리.

# ---

# 이와 같은 조치를 통해 서버실의 전력 문제를 해결하고, 장비의 안정적인 운영을 보장할 수 있습니다.

def get_report_prompt(image: str, event_explain: str, rag: str, answer: str) -> ChatPromptTemplate:
    return ChatPromptTemplate.from_messages([
        ("system", 
         "당신은 산업 안전 분석 보고서를 작성하는 전문가입니다. "
         "아래의 문제 설명, 과거 사례 요약, GPT 응답을 바탕으로 보고서를 작성해 주세요. "
         "다음 항목은 반드시 모두 포함되어야 합니다:\n"
         "1. 사건 개요\n"
         "2. 원인 분석\n"
         "3. 해결 방안 제시\n"
         "4. 참고 사례 요약\n"
         "5. 향후 예방을 위한 제언"),
        ("user", [
            {
                "type": "image_url",
                "image_url": {"url": f"data:image/jpeg;base64,{image}"}
            },
            {
                "type": "text",
                "text": (
                    f"[문제 설명]: {event_explain}\n"
                    f"[과거 사례 요약]: {rag}\n"
                    f"[GPT 분석 응답]: {answer}\n\n"
                    f"위의 정보를 바탕으로 아래 형식에 따라 보고서를 작성해 주세요.\n\n"
                    f"1. 사건 개요\n"
                    f"2. 원인 분석\n"
                    f"3. 해결 방안 제시\n"
                    f"4. 참고 사례 요약\n"
                    f"5. 향후 예방을 위한 제언"
                )
            }
        ])
    ])


# make_report_content 응답:

# ### 산업 안전 분석 보고서

# #### 1. 사건 개요
# 서버실 내에서 과도한 전력 사용으로 인해 일부 장비가 꺼지는 사고가 발생했습니다. 이로 인해 데이터 손실 및 운영 중단의 위험이 증가하였습니다.

# #### 2. 원인 분석
# - **과부하**: 서버실의 전력 사용량이 설계 용량을 초과하여 회로에 과부하가 발생했습니다.
# - **전력 관리 부족**: 전력 사용량에 대한 지속적인 모니터링과 관리가 부족하여 문제를 사전에 인지하지 못했습니다.
# - **장비 배치 문제**: 전력 소모가 큰 장비들이 한 회로에 집중되어 있어 부하가 불균형하게 분포되었습니다.

# #### 3. 해결 방안 제시
# - **전력 분석 실시**: 현재 전력 사용량을 분석하여 과부하가 발생하는 구간을 파악합니다.
# - **회로 부하 분산**: 전력 소모가 큰 장비들을 다른 회로로 분산 배치하여 부하를 균형 있게 조정합니다.
# - **전력 관리 시스템 도입**: 실시간으로 전력 사용량을 모니터링할 수 있는 시스템을 도입하여 문제 발생 시 즉각 대응할 수 있도록 합니다.

# #### 4. 참고 사례 요약
# 과거 유사한 사례에서는 전력 관리 시스템을 도입하여 실시간 모니터링을 강화하고, 정기적인 전력 사용량 점검을 통해 문제를 사전에 예방한 바 있습니다. 또한, 장비의 효율적인 배치를 통해 회로 부하를 효과적으로 분산시켰습니다.

# #### 5. 향후 예방을 위한 제언
# - **정기 점검**: 전력 사용량과 장비 상태에 대한 정기적인 점검을 실시하여 문제를 사전에 발견하고 대응합니다.
# - **교육 및 훈련**: 서버실 관리 인력에게 전력 관리 및 안전 교육을 실시하여 사고 발생 시 신속하게 대응할 수 있도록 합니다.
# - **업그레이드 계획**: 장기적으로는 전력 효율이 높은 장비로의 업그레이드를 계획하여 전반적인 전력 소모를 줄입니다.

# 이 보고서는 서버실의 안전성과 효율성을 높이기 위한 방안을 제시하며, 향후 유사한 사고를 예방하기 위한 기초 자료로 활용될 수 있습니다.