#--------------------------------------------------------------------------------------------------#
# [ 파일 개요 ]
# 이 파일은 Langchain의 ChatPromptTemplate을 사용하여 AI 모델(LLM)에게 전달할 프롬프트(지시문) 템플릿을 생성하는 함수들을 정의합니다.
# 각 함수는 특정 작업(이벤트 해결, 보고서 생성)에 필요한 시스템 메시지와 사용자 입력(이미지, 텍스트 설명, RAG 컨텍스트 등)을 구조화하여 ChatPromptTemplate 객체로 반환합니다.

# [ 주요 기능 ]
# 1. get_solve_event_prompt(image, event_explain, rag):
#    - 입력: 이미지, 사용자 설명, RAG 컨텍스트.
#    - 역할: 산업 안전 컨설턴트로서 원인 분석 및 해결 방안 제시.
#    - 출력: 상세 구조를 갖춘 전문가 보고서 형식의 답변 (한글).
#    - 반환: 해당 작업을 위한 ChatPromptTemplate 객체.
# 2. get_report_prompt(image, event_explain, rag, answer):
#    - 입력: 이미지, 사용자 설명, RAG 컨텍스트, 이전 AI 답변.
#    - 역할: 산업 안전 분석 보고서 작성 전문가.
#    - 출력: 주어진 정보를 바탕으로 특정 항목(개요, 원인, 해결방안 등) 포함 영어 보고서.
#    - 반환: 해당 작업을 위한 ChatPromptTemplate 객체.
#--------------------------------------------------------------------------------------------------#



from langchain.prompts import ChatPromptTemplate


def get_solve_event_prompt(
    image: str, event_explain: str, rag: str
) -> ChatPromptTemplate:
    return ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "당신은 산업시설 및 공정 안전 분야의 시니어 기술 컨설턴트입니다. "
                "당신의 주요 업무는 현장에서 발생한 사고 또는 이상 징후에 대해 다각도로 원인을 분석하고, "
                "기술적 · 인프라적 · 조직 운영 측면에서 실질적인 해결 방안을 제시하는 것입니다.\n\n"
                "다음의 정보(사건 설명, 참고 이미지, 관련 문헌 요약)를 바탕으로 다음 요구사항을 충족하는 분석 및 해결 방안을 작성하세요:\n\n"
                "1. **문제 개요 요약**: 사고 또는 이슈가 발생한 배경과 상황을 간결하게 요약합니다.\n"
                "2. **원인 분석**: 직접 원인(root cause), 간접 요인(contributing factors), 시스템적 결함(systemic flaws)을 분리하여 구조적으로 기술합니다.\n"
                "3. **현장의 즉각적 대응을 위한 사례 기반 비교 분석 – 실질적 통찰 제공이 핵심입니다.**\n"
                "   제공된 과거 유사 사례를 바탕으로, 현재 사건과 다음 관점에서 **문제 해결에 직접 연결될 수 있는 분석**을 수행하세요:\n"
                "   - **(1) 핵심 사례 요약**: 과거 사례의 발생 원인과 조치 사항을 '실무자 관점에서' 간결하게 요약\n"
                "   - **(2) 과거 현장 상황과의 연관성 판단**: 이번 사건과 비교했을 때 **위험 발생 조건, 감지 실패 요인, 대응의 한계**가 어떻게 유사하거나 다른지를 분석\n"
                "\n"
                "   - **(3) 과거 인사이트**: (바로 적용 가능한 인사이트 도출) 과거 대응에서 얻은 교훈 중, **이번 사고에 실질적으로 적용 가능한 기술적/운영상 조치**를 정리하고, 그 우선순위를 제시하세요\n"
                "이 항목은 단순 참고 정보가 아닌, **현장 담당자가 지금 무엇을 해야 하는지를 도출하는 지침**이어야 합니다.\n"
                "4. **기술적 해결방안**: 현장 적용 가능한 기술적 조치(장비 개선, 회로 재설계, 계측 시스템 활용 등)를 단계별로 제안합니다.\n"
                "5. **운영 절차 개선**: 작업자 교육, SOP 개정, 실시간 모니터링 강화 등 비기술적 대응 방안도 포함합니다.\n"
                "6. **예방 및 재발 방지 대책**: 해당 사건의 재발을 막기 위한 중장기 전략(예: 예측 유지보수 체계, 리스크 평가 프로토콜, KPI 연계 관리)을 기술합니다.\n\n"
                "※ 응답은 전문가 보고서 양식에 맞춰 **번호를 포함한 구조적 서술**, **간결하고 전문적인 문장**, **필요시 용어 정의**를 포함해 주세요.",
            ),
            (
                "user",
                [
                    {
                        "type": "image_url",
                        "image_url": {"url": f"data:image/jpeg;base64,{image}"},
                    },
                    {
                        "type": "text",
                        "text": (
                            f"[문제 설명]\n{event_explain}\n\n"
                            f"[참고자료 요약]\n{rag}"
                        ),
                    },
                ],
            ),
        ]
    )


def get_report_prompt(
    image: str, event_explain: str, rag: str, answer: str
) -> ChatPromptTemplate:
    return ChatPromptTemplate.from_messages(
        [
            (
                "system",
                "당신은 산업 안전 분석 보고서를 작성하는 전문가입니다. "
                "아래의 문제 설명, 과거 사례 요약, GPT 응답을 바탕으로 보고서를 작성해 주세요. "
                "다음 항목은 반드시 모두 포함되어야 합니다:\n"
                "1. 사건 개요\n"
                "2. 원인 분석\n"
                "3. 해결 방안 제시\n"
                "4. 참고 사례 요약\n"
                "5. 향후 예방을 위한 제언"
                "또한, 답변은 모두 영어로 생성하여야만 합니다."
            ),
            (
                "user",
                [
                    {
                        "type": "image_url",
                        "image_url": {"url": f"data:image/jpeg;base64,{image}"},
                    },
                    {
                        "type": "text",
                        "text": (
                            f"[문제 설명]: {event_explain}\n"
                            f"[과거 사례 요약]: {rag}\n"
                            f"[GPT 분석 응답]: {answer}\n\n"
                            f"위의 정보를 바탕으로 아래 형식에 따라 보고서를 작성해 주세요.\n\n"
                            f"1. 사건 개요\n"
                            f"2. 원인 분석\n"
                            f"3. 해결 방안 제시\n"
                            f"4. 참고 사례 요약\n"
                            f"5. 향후 예방을 위한 제언"
                        ),
                    },
                ],
            ),
        ]
    )
